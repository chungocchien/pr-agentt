\
# PR Similar Issue Module Documentation\n\n## Introduction\n\nThe `pr_similar_issue` module is a tool designed to identify and present similar issues to a given issue within a GitHub repository. It leverages vector databases (Pinecone or LanceDB) and OpenAI embeddings to perform semantic searches across existing issues and their comments. This helps users quickly find related discussions and solutions.\n\n## Architecture\n\nThe `PRSimilarIssue` class is the main entry point for this module. It orchestrates the process of indexing issues, querying for similar issues, and presenting the results. The module interacts with the following components:\n\n- **Git Providers:** Retrieves issues and comments from GitHub using the [Git Providers](git_providers.md) module, specifically the `GithubProvider`.\n- **AI Handlers:** Uses OpenAI embeddings via the [AI Handlers](ai_handlers.md) module to generate vector representations of issues and comments.\n- **Vector Databases:** Stores and queries issue embeddings using either Pinecone or LanceDB.\n- **Configuration:** Loads settings from the global configuration using the [PR Config](pr_config.md) tool.\n- **Token Handler:** Utilizes the [Token Handler](utilities_and_types.md) to count tokens in issues and comments.\n\n```mermaid\nclassDiagram\n    PRSimilarIssue --|> GitProvider : Uses\n    PRSimilarIssue --|> BaseAiHandler : Uses\n    PRSimilarIssue --|> Config : Uses\n    PRSimilarIssue --|> TokenHandler : Uses\n    PRSimilarIssue --|> Pinecone : Uses (optional)\n    PRSimilarIssue --|> LanceDB : Uses (optional)\n    PRSimilarIssue --|> Corpus : Manages\n    PRSimilarIssue --|> Record : Creates\n    PRSimilarIssue --|> Metadata : Creates\n    Record --|> Metadata : Contains\n    Corpus --|> Record : Contains\n\n    class PRSimilarIssue{\n        +__init__(issue_url: str, ai_handler, args: list)\n        +run()\n        -_process_issue(issue)\n        -_update_index_with_issues(issues_list, repo_name_for_index, upsert)\n        -_update_table_with_issues(issues_list, repo_name_for_index, ingest)\n    }\n    class GitProvider{\n        <<from git_providers module>>\n    }\n    class BaseAiHandler{\n        <<from ai_handlers module>>\n    }\n    class Config{\n        <<from pr_config tool>>\n    }\n    class TokenHandler{\n        <<from utilities_and_types module>>\n    }\n    class Pinecone{\n        <<Pinecone VectorDB>>\n    }\n    class LanceDB{\n        <<LanceDB VectorDB>>\n    }\n    class Corpus{\n        +documents: List<Record>\n        +append(r: Record)\n    }\n    class Record{\n        +id: str\n        +text: str\n        +metadata: Metadata\n    }\n    class Metadata{\n        +repo: str\n        +username: str\n        +created_at: str\n        +level: IssueLevel\n    }\n    class IssueLevel{\n        ISSUE\n        COMMENT\n    }\n```\n\n## Core Components\n\n### 1. `PRSimilarIssue`\n\n- **Purpose:** The main class responsible for finding similar issues.\n- **Initialization:**\n    - Takes an `issue_url`, an AI handler (`ai_handler`), and optional arguments (`args`) as input.\n    - Initializes the Git provider, OpenAI API key, and vector database connection (Pinecone or LanceDB) based on the configuration.\n    - Indexes the repository issues if the index doesn\'t exist or needs updating.\n- **`run()` method:**\n    - Retrieves the issue from the provided URL.\n    - Generates an embedding for the issue using OpenAI.\n    - Queries the vector database for similar issues.\n    - Publishes a comment on the issue with a list of similar issues.\n- **`_process_issue()` method:**\n    - Extracts the header, body, and comments from an issue.\n    - Concatenates the header and body into a single string for embedding.\n- **`_update_index_with_issues()` method:**\n    - Indexes or updates issues in Pinecone.\n    - Processes a list of issues, generates embeddings for each issue and its comments, and upserts them into the Pinecone index.\n- **`_update_table_with_issues()` method:**\n    - Indexes or updates issues in LanceDB.\n    - Processes a list of issues, generates embeddings for each issue and its comments, and ingests them into the LanceDB table.\n\n### 2. `Config`\n\n- **Purpose:** Represents the configuration settings for the `pr_similar_issue` module.\n- **Attributes:**\n    - `vectordb`: Specifies the vector database to use (e.g., "pinecone" or "lancedb").\n    - `force_update_dataset`: A boolean indicating whether to force a re-indexing of the entire dataset.\n    - `skip_comments`: A boolean indicating whether to skip indexing comments.\n    - `max_issues_to_scan`: The maximum number of issues to scan when indexing.\n\n### 3. `IssueLevel`\n\n- **Purpose:** An enumeration representing the level of the content being indexed (either the issue itself or a comment).\n- **Values:**\n    - `ISSUE`: Indicates that the content is from the main issue.\n    - `COMMENT`: Indicates that the content is from a comment on the issue.\n\n### 4. `Record`\n\n- **Purpose:** A data class representing a single record in the vector database.\n- **Attributes:**\n    - `id`: A unique identifier for the record.\n    - `text`: The text content of the issue or comment.\n    - `metadata`: Metadata associated with the record, such as the repository name, username, creation date, and issue level.\n\n### 5. `Corpus`\n\n- **Purpose:** A data class representing a collection of records to be indexed.\n- **Attributes:**\n    - `documents`: A list of `Record` objects.\n- **`append()` method:**\n    - Adds a `Record` to the `documents` list.\n\n### 6. `Metadata`\n\n- **Purpose:** A data class representing metadata associated with a record.\n- **Attributes:**\n    - `repo`: The name of the repository.\n    - `username`: The username of the issue or comment author.\n    - `created_at`: The creation timestamp of the issue or comment.\n    - `level`: The `IssueLevel` of the record.\n\n## Data Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant PRAgent\n    participant GitProvider\n    participant OpenAI\n    participant VectorDB\n\n    User->>PRAgent: Triggers PRSimilarIssue tool with issue URL\n    PRAgent->>GitProvider: Retrieves issue and comments\n    GitProvider->>PRAgent: Returns issue data\n    PRAgent->>OpenAI: Generates embedding for issue\n    OpenAI->>PRAgent: Returns embedding vector\n    PRAgent->>VectorDB: Queries for similar issues\n    VectorDB->>PRAgent: Returns similar issue records\n    PRAgent->>GitProvider: Retrieves similar issue details\n    GitProvider->>PRAgent: Returns similar issue data\n    PRAgent->>GitProvider: Posts comment with similar issues\n    GitProvider->>User: Displays comment on issue\n```\n\n## Configuration\n\nThe `pr_similar_issue` module relies on the following configuration settings:\n\n- `pr_similar_issue.vectordb`: Specifies the vector database to use ("pinecone" or "lancedb").\n- `pr_similar_issue.force_update_dataset`: Forces a re-indexing of the entire dataset.\n- `pr_similar_issue.skip_comments`: Skips indexing comments.\n- `pr_similar_issue.max_issues_to_scan`: Limits the number of issues scanned during indexing.\n- `openai.key`: OpenAI API key.\n- `pinecone.api_key`: Pinecone API key (if using Pinecone).\n- `pinecone.environment`: Pinecone environment (if using Pinecone).\n- `lancedb.uri`: LanceDB URI (if using LanceDB).\n\nThese settings can be configured in the `config.toml` file or through environment variables, as described in the [PR Config](pr_config.md) documentation.\n